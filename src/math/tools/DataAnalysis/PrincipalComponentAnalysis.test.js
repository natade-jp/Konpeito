import PrincipalComponentAnalysis from "./PrincipalComponentAnalysis.js";
import Matrix from "../../core/Matrix.js";
const $ = Matrix.create;

/**
 * @type {number}
 */
let test_count = 0;

/**
 * check x === y
 * @param {string} name
 * @param {any} x 
 * @param {any} y 
 */
const equalResultsValue = function(name, x, y) {
	
	/**
	 * @type {boolean}
	 */
	let result = false;
	/**
	 * @type {string}
	 */
	let text_x = "";
	/**
	 * @type {string}
	 */
	let text_y = "";

	const target_x = (x !== undefined) ? $(x) : $(0);
	const target_y = (y !== undefined) ? $(y) : $(0);
	result = false;
	if((x !== undefined) && (y !== undefined)) {
		text_x = target_x.toOneLineString();
		text_y = target_y.toOneLineString();
		result = target_x.equals(target_y, 0.001);
		// SVDを利用しており、符号が反転する可能性があるので、符号が逆でも正解とする。
		if(!result) {
			target_x.negate().equals(target_y, 0.001);
		}
	}
	else if(x !== undefined) {
		text_x = target_x.toOneLineString();
		text_y = "undefined";
		result = false;
	}
	else if(y !== undefined) {
		text_x = "undefined";
		text_y = target_y.toOneLineString();
		result = false;
	}
	else {
		text_x = "undefined";
		text_y = "undefined";
		result = false;
	}
	
	test_count++;
	test(test_count + " " + name + " " + " = " + text_x + " === " + text_y, () => { expect(result).toBe(true); });
};

/**
 * check x[key] === y[key]
 * @param {string} name
 * @param {string} key
 * @param {any} x 
 * @param {any} y 
 */
const equalResultsKeyValue = function(name, key, x, y) {
	equalResultsValue(name + " " + key, x[key], y[key]);
};

/**
 * check x === y
 * @param {string} name
 * @param {any} x 
 * @param {any} y 
 */
const equalResultsArray = function(name, x, y) {
	for(const key in x) {
		if(key in y) {
			equalResultsKeyValue(name, key, x, y);
		}
		else {
			const text_x = $(x[key]).toOneLineString();
			const text_y = "undefined";
			const result = false;
			test_count++;
			test(test_count + " " + name + " " + key + " = " + text_x + " === " + text_y, () => { expect(result).toBe(true); });
		}
	}
};

// 試験データは、正解データと確認できるように以下の文献にあるデータを使用しています。
// 図解でわかる多変量解析―データの山から本質を見抜く科学的分析ツール
// 涌井 良幸, 涌井 貞美, 日本実業出版社 (2001/01)

{
	//  "[33 15 38 11 71 94 7 4 8 37;10 6 24 18 75 46 29 5 5 10;67 5 18 1 32 4 12 25 24 14;25 5 12 2 33 4 18 40 23 8;52 32 24 5 32 32 3 11 5 35;23 7 12 1 8 1 3 32 15 11;32 13 12 0 37 2 6 23 16 9;48 26 24 3 20 32 2 10 21 23;27 14 18 2 20 7 3 9 12 11;41 25 20 4 24 8 2 12 12 17]";
	const x = [[33, 15, 38, 11, 71, 94, 7, 4, 8, 37],
		[10, 6, 24, 18, 75, 46, 29, 5, 5, 10],
		[67, 5, 18, 1, 32, 4, 12, 25, 24, 14],
		[25, 5, 12, 2, 33, 4, 18, 40, 23, 8],
		[52, 32, 24, 5, 32, 32, 3, 11, 5, 35],
		[23, 7, 12, 1, 8, 1, 3, 32, 15, 11],
		[32, 13, 12, 0, 37, 2, 6, 23, 16, 9],
		[48, 26, 24, 3, 20, 32, 2, 10, 21, 23],
		[27, 14, 18, 2, 20, 7, 3, 9, 12, 11],
		[41, 25, 20, 4, 24, 8, 2, 12, 12, 17]];

	const result = PrincipalComponentAnalysis.runPrincipalComponentAnalysis({ samples : x });
	const ans = {
		"principal_component": [
			{
				"eigen_value": 1418.4993824404005,
				"factor_loading": [
					-0.08313229769812834,
					0.034731102432792565,
					0.19379214994934418,
					0.12402164794275147,
					0.496543457565275,
					0.7678214990258458,
					0.0703601237355887,
					-0.2260685613586707,
					-0.11448588991010157,
					0.18351072178556369
				],
				"factor_loading_contribution_rate": [
					0.0069109789205702345,
					0.0012062494761971296,
					0.0375553973819891,
					0.015381369158435791,
					0.24655540525087807,
					0.589549854366297,
					0.004950547012087352,
					0.05110699443477906,
					0.013107018988507897,
					0.033676185010258555
				],
				"cumulative_contribution_ratio": 0.6455777885525693,
				"contribution_ratio": 0.6455777885525693,
				"score": [
					83.8949164883162,
					45.49070506915132,
					-23.312241903018077,
					-24.31831931265454,
					10.590999603519862,
					-36.70409917707182,
					-20.43615303132857,
					0.6303829306815075,
					-19.398251037277856,
					-16.437939630318024
				]
			},
			{
				"eigen_value": 451.8470756282555,
				"factor_loading": [
					-0.6293482182261729,
					-0.3580079330557668,
					-0.13467492693739183,
					0.09586281125205745,
					0.3920666817650974,
					-0.18308634154025002,
					0.32334512576412644,
					0.17081164124574152,
					-0.013599742761961237,
					-0.3567542487558886
				],
				"factor_loading_contribution_rate": [
					0.39607917978445856,
					0.12816968013086238,
					0.018137335945591828,
					0.009189678581147593,
					0.15371628295029416,
					0.03352060845859308,
					0.10455207035541875,
					0.02917661678506391,
					0.00018495300319151705,
					0.12727359400537847
				],
				"cumulative_contribution_ratio": 0.8512193555909608,
				"contribution_ratio": 0.2056415670383916,
				"score": [
					-8.66224721520002,
					38.90530133113553,
					-10.366444796146002,
					24.018530032562943,
					-28.67836481571615,
					8.034804951545206,
					11.446247368401089,
					-25.34015181429272,
					2.0175834084513533,
					-11.375258450741264
				]
			},
			{
				"eigen_value": 167.3096635481876,
				"factor_loading": [
					-0.6968819962928339,
					0.2773578940071219,
					0.009657092115531798,
					0.02457780982847971,
					-0.4490026336837947,
					0.09052827682744234,
					-0.2781563745704192,
					-0.2814975437892439,
					-0.2625561022230565,
					0.03720856168041589
				],
				"factor_loading_contribution_rate": [
					0.4856445167570853,
					0.07692740136806588,
					0.00009325942812786642,
					0.0006040687359649139,
					0.20160336505498397,
					0.008195368905346034,
					0.07737096871415934,
					0.0792408671593773,
					0.06893570681456408,
					0.0013844770623253138
				],
				"cumulative_contribution_ratio": 0.927364191418164,
				"contribution_ratio": 0.07614483582720315,
				"score": [
					-0.8812974593107219,
					-0.0716556769506621,
					-30.783151261380233,
					-7.8485714657503225,
					2.0641060860900633,
					13.665211988329592,
					-2.535668979286219,
					4.438616234393011,
					15.318959494310675,
					6.633451039554808
				]
			},
			{
				"eigen_value": 94.76331295019017,
				"factor_loading": [
					-0.16215527761295553,
					-0.3094864551021932,
					-0.0025286859964957194,
					-0.1479982457845702,
					-0.3371614358340465,
					0.4518922209394569,
					-0.131054807792065,
					0.6493560830379191,
					0.28392074642298215,
					0.13667419804025352
				],
				"factor_loading_contribution_rate": [
					0.026294334057734677,
					0.09578186589172184,
					0.00000639425286887355,
					0.021903480755310047,
					0.11367783381367585,
					0.20420657934559494,
					0.0171753626454151,
					0.42166332257834893,
					0.08061099024938333,
					0.01867983640994644
				],
				"cumulative_contribution_ratio": 0.97049222571103,
				"contribution_ratio": 0.04312803429286599,
				"score": [
					12.051954043454103,
					-12.24897021524265,
					-1.976479460934281,
					12.2141010973221,
					-6.290295412905245,
					14.050426296475516,
					-4.670477925492559,
					2.9415184407762505,
					-6.049306414968108,
					-10.022470448485127
				]
			},
			{
				"eigen_value": 33.64489151740879,
				"factor_loading": [
					0.08621950050768327,
					-0.491822546971985,
					0.17856627133638212,
					0.00623991668599315,
					-0.27271155151589554,
					0.16374934075462344,
					-0.0545477565101826,
					-0.5447294318415614,
					0.36217007792757905,
					-0.43208068259804766
				],
				"factor_loading_contribution_rate": [
					0.007433802267794397,
					0.2418894177100104,
					0.03188591325897844,
					0.00003893656024813574,
					0.07437159033020695,
					0.02681384659757378,
					0.0029754577402941683,
					0.2967301539144303,
					0.13116716534606868,
					0.1866937162743948
				],
				"cumulative_contribution_ratio": 0.9858044598443518,
				"contribution_ratio": 0.015312234133321848,
				"score": [
					1.3241080492722226,
					1.1952876374494394,
					5.458901879242205,
					-5.768100403952497,
					-11.27004452153442,
					0.37856548120614475,
					-3.5822668057817775,
					6.175038169455098,
					7.510547324047438,
					-1.4220368094038256
				]
			},
			{
				"eigen_value": 16.007386617332596,
				"factor_loading": [
					-0.02522802084736988,
					0.38689761119181704,
					0.06346853029837579,
					0.33207645626602245,
					-0.3241278401657571,
					0.11537392999208722,
					0.72324887148485,
					0.026739981225948197,
					0.303015018195202,
					-0.03713084741162839
				],
				"factor_loading_contribution_rate": [
					0.0006364530358753292,
					0.14968976154593444,
					0.004028254338235846,
					0.11027477280619952,
					0.10505885677051857,
					0.013311143721819043,
					0.523088930104109,
					0.0007150265959640621,
					0.09181810125183859,
					0.001378699829505631
				],
				"cumulative_contribution_ratio": 0.9930896327396299,
				"contribution_ratio": 0.007285172895278129,
				"score": [
					-4.0499983509025625,
					3.68138637668328,
					-1.229496528322526,
					4.11758079514991,
					1.11411361131991,
					-1.2313357927469077,
					-6.447048707863752,
					6.662842804367501,
					-2.632432084556368,
					0.014387876871521363
				]
			},
			{
				"eigen_value": 13.299129292543398,
				"factor_loading": [
					0.13981562625379856,
					-0.5046806709549774,
					0.09126226096847895,
					0.29437895604617254,
					-0.2977467964837609,
					-0.022940689023579052,
					0.2785390446015372,
					-0.001808460219722022,
					-0.6277093692510964,
					0.26452880525388406
				],
				"factor_loading_contribution_rate": [
					0.019548409344741887,
					0.25470257963556614,
					0.008328800277078757,
					0.08665896976283438,
					0.08865315481634213,
					0.0005262752128765604,
					0.07758399936753714,
					0.000003270528366317024,
					0.39401905224560935,
					0.06997548880904732
				],
				"cumulative_contribution_ratio": 0.9991422419861592,
				"contribution_ratio": 0.006052609246529295,
				"score": [
					-0.7082673373060899,
					2.17814711032511,
					3.227228089566965,
					-2.5113257172998504,
					3.58641564507562,
					5.069438093906328,
					-5.957155742614923,
					-4.454985343942889,
					1.1520054249540164,
					-1.5815002226642723
				]
			},
			{
				"eigen_value": 1.0729119485696061,
				"factor_loading": [
					0.049339123131676564,
					0.11709401545366453,
					0.5422373266646412,
					0.5956463174259559,
					0.054084114843108204,
					-0.07483748194563965,
					-0.35528234137375597,
					0.30254281434098973,
					-0.044145006856523505,
					-0.32681274480647393
				],
				"factor_loading_contribution_rate": [
					0.0024343490714027415,
					0.01371100845506303,
					0.2940213184284168,
					0.3547945354631026,
					0.002925091478362517,
					0.00560064870396394,
					0.12622554209201808,
					0.09153215450936658,
					0.0019487816303625073,
					0.10680657016794146
				],
				"cumulative_contribution_ratio": 0.9996305383729208,
				"contribution_ratio": 0.0004882963867615899,
				"score": [
					0.37846422827125625,
					0.01926593306228952,
					0.09729786402210427,
					-0.16716919265941632,
					-1.0030616695623982,
					0.5267182756290054,
					-0.6079618628191277,
					-0.4751119127742256,
					-1.233262069084566,
					2.464820405915084
				]
			},
			{
				"eigen_value": 0.8118016126638321,
				"factor_loading": [
					0.18764230879052085,
					0.062082770010794076,
					-0.7558478183998693,
					0.38365272814595075,
					-0.06032654718954927,
					0.2726553551277929,
					-0.16823212478539404,
					0.037714090456392214,
					-0.137605027565512,
					-0.34029542196470247
				],
				"factor_loading_contribution_rate": [
					0.03520963604823718,
					0.0038542703322131523,
					0.5713059245798418,
					0.1471894158138308,
					0.0036392922958129155,
					0.07434094267986285,
					0.02830204780980839,
					0.0014223526189529343,
					0.018935143611305313,
					0.11580097421013491
				],
				"cumulative_contribution_ratio": 0.9999999999999998,
				"contribution_ratio": 0.0003694616270789571,
				"score": [
					-0.38929752408477203,
					0.6122585842848951,
					0.0398452799111666,
					-1.2470224304478474,
					-0.010297096727386545,
					1.1101264809618625,
					1.0097992665264095,
					0.8356328148856935,
					-1.3987545093620795,
					-0.5622908659479374
				]
			},
			{
				"eigen_value": 0,
				"factor_loading": [
					0.14074210710409282,
					0.18457455256444721,
					0.18611126271365377,
					-0.5039491763689339,
					-0.09899054115886624,
					0.20960613542564316,
					0.19435810803553508,
					0.1685504104870425,
					-0.44640014209134055,
					-0.5816618074285661
				],
				"factor_loading_contribution_rate": [
					0.019808340712099935,
					0.034067765454365885,
					0.03463740210887065,
					0.2539647723629268,
					0.009799127238925192,
					0.04393473200807306,
					0.037775074159152724,
					0.028409240875350527,
					0.19927308685916903,
					0.33833045822106633
				],
				"cumulative_contribution_ratio": 0.9999999999999998,
				"contribution_ratio": 0,
				"score": [
					1.5987211554602254e-14,
					-5.5067062021407764e-14,
					1.3322676295501878e-15,
					-3.375077994860476e-14,
					4.973799150320701e-14,
					-4.884981308350689e-15,
					-1.687538997430238e-14,
					2.5757174171303632e-14,
					-6.217248937900877e-15,
					2.6367796834847468e-14
				]
			}
		]
	};

	for(const key in result.principal_component) {
		equalResultsArray("PrincipalComponentAnalysis 1 " + key, result.principal_component[key], ans.principal_component[key]);
	}
}

{
	//  "[60 58 25;35 40 75;74 68 50;30 40 60;80 70 50;90 95 80;50 50 45]";
	const x = [
		[60, 58, 25],
		[35, 40, 75],
		[74, 68, 50],
		[30, 40, 60],
		[80, 70, 50],
		[90, 95, 80],
		[50, 50, 45]
	];
	const result = PrincipalComponentAnalysis.runPrincipalComponentAnalysis({ samples : x });
	const ans = {
		"principal_component": [
			{
				"eigen_value": 888.7330576583687,
				"factor_loading": [
					-0.7540305186100958,
					-0.6497203019545166,
					-0.09644431674661677
				],
				"factor_loading_contribution_rate": [
					0.5685620229954101,
					0.4221364707718682,
					0.009301506232721744
				],
				"cumulative_contribution_ratio": 0.7096887295925846,
				"contribution_ratio": 0.7096887295925846,
				"score": [
					4.177868646785311,
					29.901381209888164,
					-15.286869551966616,
					35.118198554137905,
					-21.11049326753622,
					-47.78713550489859,
					14.987049913590067
				]
			},
			{
				"eigen_value": 353.3864925612909,
				"factor_loading": [
					0.17454822946406967,
					-0.056652439796483364,
					-0.9830175057729463
				],
				"factor_loading_contribution_rate": [
					0.030467084409041518,
					0.003209498934894172,
					0.9663234166560646
				],
				"cumulative_contribution_ratio": 0.9918819132486468,
				"contribution_ratio": 0.2821931836560623,
				"score": [
					29.63685871981858,
					-22.857978389093777,
					6.938571890027062,
					-8.985456949819932,
					7.872556387218514,
					-21.28879748624126,
					8.684245828090823
				]
			},
			{
				"eigen_value": 10.166164066051495,
				"factor_loading": [
					-0.6332226248291736,
					0.7580593844107715,
					-0.15612519691329116
				],
				"factor_loading_contribution_rate": [
					0.4009708925955483,
					0.5746540302932378,
					0.02437507711121394
				],
				"cumulative_contribution_ratio": 0.9999999999999999,
				"contribution_ratio": 0.008118086751353027,
				"score": [
					2.9688825658286238,
					-2.6518805785004824,
					-2.21877026050437,
					2.8561104993447533,
					-4.5019872406578685,
					3.4335152139209475,
					0.11412980056836508
				]
			}
		]
	};

	for(const key in result.principal_component) {
		equalResultsArray("PrincipalComponentAnalysis 2 " + key, result.principal_component[key], ans.principal_component[key]);
	}

}

